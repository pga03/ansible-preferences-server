---
- name: Update the RawPreferencesServer config file's couchdb address
  replace:
    dest: "{{ nodejs_app_install_dir }}/gpii/node_modules/rawPreferencesServer/configs/production.json"
    regexp: 'http://localhost:5984'
    replace: '{{ preferences_server_couchdb_host_address }}'
  notify: Restart the application systemd unit

- name: Update the RawPreferencesServer config file's endpoint for retrieving preferences
  replace:
    dest: "{{ nodejs_app_install_dir }}/gpii/node_modules/rawPreferencesServer/configs/production.json"
    regexp: '/user/%userToken'
    replace: '/preferences/%userToken'
  notify: Restart the application systemd unit

- name: Overwrite localhost:5984 with DEFAULTHOST
  replace:
    dest: "{{ nodejs_app_install_dir }}/gpii/node_modules/preferencesServer/configs/development.json"
    regexp: 'http://localhost:5984'
    replace: '{{ preferences_server_couchdb_host_address }}'
  notify: Restart the application systemd unit

- name: Overwrite DEFAULTHOST with the environment provided host
  replace:
    dest: "{{ nodejs_app_install_dir }}/gpii/node_modules/preferencesServer/configs/development.json"
    regexp: 'DEFAULTHOST'
    replace: '{{ preferences_server_couchdb_host_address }}'
  notify: Restart the application systemd unit

- name: Update the raw preferences server path for retrieving preferences
  replace:
    dest: "{{ nodejs_app_install_dir }}/gpii/node_modules/preferencesServer/configs/development.json"
    regexp: '/rawPreferences/'
    replace: '/preferences/'
  notify: Restart the application systemd unit
